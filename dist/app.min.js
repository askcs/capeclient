/*!
 * CapeClient v1.0.0 (snapshot)
 * Ask Community Systems
 * Authors: Sven Stam, Cengiz Ulusoy
 * 25-04-2013 11:04
 */
"use strict";angular.module("CapeClient",["CapeClient.Modals.Cape","CapeClient.Controllers.Login","CapeClient.Controllers.Dashboard","$strap.directives"]),angular.module("CapeClient").value("$config",{title:"CapeClient",version:"1.0.0",host:"http://openid.ask-cs.com:5280/http-bind"}),angular.module("CapeClient").config(["$locationProvider","$routeProvider","$httpProvider",function(t,e){e.when("/login",{templateUrl:"js/views/login.html",controller:"login"}).when("/dashboard",{templateUrl:"js/views/dashboard.html",controller:"dashboard"}).otherwise({redirectTo:"/login"})}]),angular.module("CapeClient").run(["$rootScope","$location","Cape",function(t,e,n){t.login=function(o){n.login(o.name,o.password,function(){t.$apply(function(){e.path("/dashboard")})})},t.logout=function(){n.disconnect(function(){e.path("/login")})},t.location=e.path(),t.$on("$routeChangeStart",function(){}),t.$on("$routeChangeSuccess",function(){t.location=e.path()}),t.$on("$routeChangeError",function(e,n,o,i){t.notifier.error(i)})}]),angular.module("CapeClient.Controllers.Login",[]).controller("login",["$rootScope","$scope","Cape",function(t,e){e.user={name:"sstam",password:"askask"}}]),angular.module("CapeClient.Controllers.Dashboard",[]).controller("dashboard",["$rootScope","$scope",function(){}]),angular.module("$strap.config",[]).value("$strap.config",{}),angular.module("$strap.filters",["$strap.config"]),angular.module("$strap.directives",["$strap.config"]),angular.module("$strap",["$strap.filters","$strap.directives","$strap.config"]),angular.module("$strap.directives").directive("bsAlert",["$parse","$timeout","$compile",function(t,e,n){return{restrict:"A",link:function(e,o,i){var a=t(i.bsAlert),r=(a.assign,a(e));i.bsAlert?e.$watch(i.bsAlert,function(t,a){r=t,o.html((t.title?"<strong>"+t.title+"</strong>&nbsp;":"")+t.content||""),t.closed&&o.hide(),n(o.contents())(e),(t.type||a.type)&&(a.type&&o.removeClass("alert-"+a.type),t.type&&o.addClass("alert-"+t.type)),(angular.isUndefined(i.closeButton)||"0"!==i.closeButton&&"false"!==i.closeButton)&&o.prepend('<button type="button" class="close" data-dismiss="alert">&times;</button>')},!0):(angular.isUndefined(i.closeButton)||"0"!==i.closeButton&&"false"!==i.closeButton)&&o.prepend('<button type="button" class="close" data-dismiss="alert">&times;</button>'),o.addClass("alert").alert(),o.hasClass("fade")&&(o.removeClass("in"),setTimeout(function(){o.addClass("in")}));var s=i.ngRepeat&&i.ngRepeat.split(" in ").pop();o.on("close",function(t){var n;s?(t.preventDefault(),o.removeClass("in"),n=function(){o.trigger("closed"),e.$parent&&e.$parent.$apply(function(){for(var t=s.split("."),n=e.$parent,o=0;t.length>o;++o)n&&(n=n[t[o]]);n&&n.splice(e.$index,1)})},$.support.transition&&o.hasClass("fade")?o.on($.support.transition.end,n):n()):r&&(t.preventDefault(),o.removeClass("in"),n=function(){o.trigger("closed"),e.$apply(function(){r.closed=!0})},$.support.transition&&o.hasClass("fade")?o.on($.support.transition.end,n):n())})}}}]),angular.module("$strap.directives").directive("bsButton",["$parse","$timeout",function(t){return{restrict:"A",require:"?ngModel",link:function(e,n,o,i){if(i){n.parent('[data-toggle="buttons-checkbox"], [data-toggle="buttons-radio"]').length||n.attr("data-toggle","button");var a=!!e.$eval(o.ngModel);a&&n.addClass("active"),e.$watch(o.ngModel,function(t,e){var o=!!t,i=!!e;o!==i?$.fn.button.Constructor.prototype.toggle.call(r):o&&!a&&n.addClass("active")})}n.hasClass("btn")||n.on("click.button.data-api",function(){n.button("toggle")}),n.button();var r=n.data("button");r.toggle=function(){if(!i)return $.fn.button.Constructor.prototype.toggle.call(this);var o=n.parent('[data-toggle="buttons-radio"]');o.length?(n.siblings("[ng-model]").each(function(n,o){t($(o).attr("ng-model")).assign(e,!1)}),e.$digest(),i.$modelValue||(i.$setViewValue(!i.$modelValue),e.$digest())):e.$apply(function(){i.$setViewValue(!i.$modelValue)})}}}}]).directive("bsButtonsCheckbox",["$parse",function(){return{restrict:"A",require:"?ngModel",compile:function(t){t.attr("data-toggle","buttons-checkbox").find("a, button").each(function(t,e){$(e).attr("bs-button","")})}}}]).directive("bsButtonsRadio",["$parse",function(){return{restrict:"A",require:"?ngModel",compile:function(t,e){return t.attr("data-toggle","buttons-radio"),e.ngModel||t.find("a, button").each(function(t,e){$(e).attr("bs-button","")}),function(t,e,n,o){o&&(e.find("[value]").button().filter('[value="'+t.$eval(n.ngModel)+'"]').addClass("active"),e.on("click.button.data-api",function(e){t.$apply(function(){o.$setViewValue($(e.target).closest("button").attr("value"))})}),t.$watch(n.ngModel,function(o,i){if(o!==i){var a=e.find('[value="'+t.$eval(n.ngModel)+'"]');a.length&&$.fn.button.Constructor.prototype.toggle.call(a.data("button"))}}))}}}}]),angular.module("$strap.directives").directive("bsButtonSelect",["$parse","$timeout",function(t){return{restrict:"A",require:"?ngModel",link:function(e,n,o,i){var a=t(o.bsButtonSelect);a.assign,i&&(n.text(e.$eval(o.ngModel)),e.$watch(o.ngModel,function(t){n.text(t)}));var r,s,l,c;n.bind("click",function(){r=a(e),s=i?e.$eval(o.ngModel):n.text(),l=r.indexOf(s),c=l>r.length-2?r[0]:r[l+1],console.warn(r,c),e.$apply(function(){n.text(c),i&&i.$setViewValue(c)})})}}}]),angular.module("$strap.directives").directive("bsDatepicker",["$timeout",function(){var t="ontouchstart"in window&&!window.navigator.userAgent.match(/PhantomJS/i),e={"/":"[\\/]","-":"[-]",".":"[.]",dd:"(?:(?:[0-2]?[0-9]{1})|(?:[3][01]{1}))",d:"(?:(?:[0-2]?[0-9]{1})|(?:[3][01]{1}))",mm:"(?:[0]?[1-9]|[1][012])",m:"(?:[0]?[1-9]|[1][012])",yyyy:"(?:(?:[1]{1}[0-9]{1}[0-9]{1}[0-9]{1})|(?:[2]{1}[0-9]{3}))(?![[0-9]])",yy:"(?:(?:[0-9]{1}[0-9]{1}))(?![[0-9]])"};return{restrict:"A",require:"?ngModel",link:function(n,o,i,a){var r=function(t,n){n||(n={});var o=t,i=e;return angular.forEach(i,function(t,e){o=o.split(e).join(t)}),RegExp("^"+o+"$",["i"])},s=t?"yyyy/mm/dd":r(i.dateFormat||"mm/dd/yyyy");a&&a.$parsers.unshift(function(t){return!t||s.test(t)?(a.$setValidity("date",!0),t):(a.$setValidity("date",!1),void 0)});var l=o.next('[data-toggle="datepicker"]');if(l.length&&l.on("click",function(){t?o.trigger("focus"):o.datepicker("show")}),t&&"text"===o.prop("type"))o.prop("type","date"),o.on("change",function(){n.$apply(function(){a.$setViewValue(o.val())})});else{a&&o.on("changeDate",function(){n.$apply(function(){a.$setViewValue(o.val())})});var c=o.closest(".popover");c&&c.on("hide",function(){var t=o.data("datepicker");t&&(t.picker.remove(),o.data("datepicker",null))}),o.attr("data-toggle","datepicker"),o.datepicker({autoclose:!0,forceParse:i.forceParse||!1,language:i.language||"en"})}}}}]),angular.module("$strap.directives").directive("bsDropdown",["$parse","$compile",function(t,e){var n=Array.prototype.slice,o='<ul class="dropdown-menu" role="menu" aria-labelledby="drop1"><li ng-repeat="item in items" ng-class="{divider: !!item.divider, \'dropdown-submenu\': !!item.submenu && item.submenu.length}"><a ng-hide="!!item.divider" tabindex="-1" ng-href="{{item.href}}" ng-click="{{item.click}}" target="{{item.target}}" ng-bind-html-unsafe="item.text"></a></li></ul>',i=function(t,n,i){for(var r,s,l,c=0,u=t.length;u>c;c++)(r=t[c].submenu)&&(l=i.$new(),l.items=r,s=e(o)(l),s=s.appendTo(n.children("li:nth-child("+(c+1)+")")),a(r,s,l))},a=function(){var t=n.call(arguments);setTimeout(function(){i.apply(null,t)})};return{restrict:"EA",scope:!0,link:function(n,i,r){var s=t(r.bsDropdown);n.items=s(n);var l=e(o)(n);a(n.items,l,n),l.insertAfter(i),i.addClass("dropdown-toggle").attr("data-toggle","dropdown")}}}]),angular.module("$strap.directives").directive("bsModal",["$parse","$compile","$http","$timeout","$q","$templateCache",function(t,e,n,o,i,a){return{restrict:"A",scope:!0,link:function(r,s,l){var c=t(l.bsModal),u=(c.assign,c(r));i.when(a.get(u)||n.get(u,{cache:!0})).then(function(t){angular.isObject(t)&&(t=t.data);var n=c(r).replace(".html","").replace(/[\/|\.|:]/g,"-")+"-"+r.$id,i=$('<div class="modal hide" tabindex="-1"></div>').attr("id",n).attr("data-backdrop",l.backdrop||!0).attr("data-keyboard",l.keyboard||!0).addClass(l.modalClass?"fade "+l.modalClass:"fade").html(t);$("body").append(i),s.attr("href","#"+n).attr("data-toggle","modal"),o(function(){e(i)(r)}),r._modal=function(t){i.modal(t)},r.hide=function(){i.modal("hide")},r.show=function(){i.modal("show")},r.dismiss=r.hide})}}}]),angular.module("$strap.directives").directive("bsNavbar",["$location",function(t){return{restrict:"A",link:function(e,n){e.$watch(function(){return t.path()},function(t){n.find("li[data-match-route]").each(function(e,n){var o=angular.element(n),i=o.attr("data-match-route"),a=RegExp("^"+i+"$",["i"]);a.test(t)?o.addClass("active"):o.removeClass("active")})})}}}]),angular.module("$strap.directives").directive("bsPopover",["$parse","$compile","$http","$timeout","$q","$templateCache",function(t,e,n,o,i,a){return $("body").on("keyup",function(t){27===t.keyCode&&$(".popover.in").each(function(){$(this).popover("hide")})}),{restrict:"A",scope:!0,link:function(o,r,s){var l=t(s.bsPopover),c=(l.assign,l(o)),u={};angular.isObject(c)&&(u=c),i.when(u.content||a.get(c)||n.get(c,{cache:!0})).then(function(t){angular.isObject(t)&&(t=t.data),s.unique&&r.on("show",function(){$(".popover.in").each(function(){var t=$(this),e=t.data("popover");e&&!e.$element.is(r)&&t.popover("hide")})}),s.hide&&o.$watch(s.hide,function(t,e){t?n.hide():t!==e&&n.show()}),r.popover(angular.extend({},u,{content:t,html:!0}));var n=r.data("popover");n.hasContent=function(){return this.getTitle()||t},n.getPosition=function(){var t=$.fn.popover.Constructor.prototype.getPosition.apply(this,arguments);return e(this.$tip)(o),o.$digest(),this.$tip.data("popover",this),t},o._popover=function(t){r.popover(t)},o.hide=function(){r.popover("hide")},o.show=function(){r.popover("show")},o.dismiss=o.hide})}}}]),angular.module("$strap.directives").directive("bsTabs",["$parse","$compile",function(t,e){return{restrict:"A",link:function(t,n){var o=['<ul class="nav nav-tabs">',"</ul>"],i=['<div class="tab-content">',"</div>"];n.find("[data-tab]").each(function(e){var n=angular.element(this),a="tab-"+t.$id+"-"+e,r=n.hasClass("active"),s=n.hasClass("fade"),l=t.$eval(n.data("tab"));o.splice(e+1,0,"<li"+(r?' class="active"':"")+'><a href="#'+a+'" data-toggle="tab">'+l+"</a></li>"),i.splice(e+1,0,'<div class="tab-pane '+n.attr("class")+(s&&r?" in":"")+'" id="'+a+'">'+this.innerHTML+"</div>")}),n.html(o.join("")+i.join("")),e(n.children("div.tab-content"))(t)}}}]),angular.module("$strap.directives").directive("bsTimepicker",["$timeout",function(){var t="((?:(?:[0-1][0-9])|(?:[2][0-3])|(?:[0-9])):(?:[0-5][0-9])(?::[0-5][0-9])?(?:\\s?(?:am|AM|pm|PM))?)";return{restrict:"A",require:"?ngModel",link:function(e,n,o,i){i&&n.on("change",function(){e.$apply(function(){i.$setViewValue(n.val())})});var a=RegExp("^"+t+"$",["i"]);i.$parsers.unshift(function(t){return!t||a.test(t)?(i.$setValidity("time",!0),t):(i.$setValidity("time",!1),void 0)});var r=n.closest(".popover");r&&r.on("hide",function(){var t=n.data("timepicker");t&&(t.$widget.remove(),n.data("timepicker",null))}),n.attr("data-toggle","timepicker"),n.timepicker()}}}]),angular.module("$strap.directives").directive("bsTooltip",["$parse","$compile",function(t){return{restrict:"A",scope:!0,link:function(e,n,o){var i=t(o.bsTooltip),a=(i.assign,i(e));e.$watch(o.bsTooltip,function(t,e){t!==e&&(a=t)}),o.unique&&n.on("show",function(){$(".tooltip.in").each(function(){var t=$(this),e=t.data("tooltip");e&&!e.$element.is(n)&&t.tooltip("hide")})}),n.tooltip({title:function(){return angular.isFunction(a)?a.apply(null,arguments):a},html:!0});var r=n.data("tooltip");r.show=function(){var t=$.Event("show");if(this.$element.trigger(t),!t.isDefaultPrevented()){var e=$.fn.tooltip.Constructor.prototype.show.apply(this,arguments);return this.tip().data("tooltip",this),e}},r.hide=function(){var t=$.Event("hide");return this.$element.trigger(t),t.isDefaultPrevented()?void 0:$.fn.tooltip.Constructor.prototype.hide.apply(this,arguments)},e._tooltip=function(t){n.tooltip(t)},e.hide=function(){n.tooltip("hide")},e.show=function(){n.tooltip("show")},e.dismiss=e.hide}}}]),angular.module("$strap.directives").directive("bsTypeahead",["$parse",function(t){return{restrict:"A",require:"?ngModel",link:function(e,n,o,i){var a=t(o.bsTypeahead),r=(a.assign,a(e));e.$watch(o.bsTypeahead,function(t,e){t!==e&&(r=t)}),n.attr("data-provide","typeahead"),n.typeahead({source:function(){return angular.isFunction(r)?r.apply(null,arguments):r},minLength:o.minLength||1,items:o.items,updater:function(t){return i&&e.$apply(function(){i.$setViewValue(t)}),t}});var s=n.data("typeahead");s.lookup=function(){var t;return this.query=this.$element.val()||"",this.query.length<this.options.minLength?this.shown?this.hide():this:(t=$.isFunction(this.source)?this.source(this.query,$.proxy(this.process,this)):this.source,t?this.process(t):this)},"0"===o.minLength&&setTimeout(function(){n.on("focus",function(){0===n.val().length&&setTimeout(n.typeahead.bind(n,"lookup"),200)})})}}}]),angular.module("CapeClient.Modals.Cape",[]).factory("Cape",["$rootScope","$config","$q",function(t,e){var n=function(){this.server=e.host,this.requestid=0,this.stateAgentUrl=null,this.requests=[],this.connection=new Strophe.Connection(this.server);var t=localStorage.capeclient_sid,n=localStorage.capeclient_rid,o=localStorage.capeclient_jid;this.userid=localStorage.capeclient_uid;var i=this;null!==t&&null!=o&&(console.log("reconnecting"),this.connection.attach(o,t,n+1,function(t){t==Strophe.Status.ATTACHED?(console.log("reconnected"),$iq({to:Strophe.getDomainFromJid(o),type:"get"}).c("query",{xmlns:"http://jabber.org/protocol/disco#info"}),i.connected()):t==Strophe.Status.CONNFAIL?console.log("Strophe failed to connect."):t==Strophe.Status.DISCONNECTING?console.log("Strophe is disconnecting."):t==Strophe.Status.DISCONNECTED?(console.log("Strophe is disconnected."),i.disconnected()):t==Strophe.Status.CONNECTED?(console.log("Strophe is connected."),i.connected(null)):t==Strophe.Status.CONNFAIL&&console.log("Strophe failed to connect.")}))},o=function(t){this.connection=t};return o.prototype.send=function(t,e,n,o){var i={};i.id=t,i.method=n,i.params=o;var a=JSON.stringify(i),r=$msg({to:e,from:this.username,type:"chat"}).c("body").t(a);this.connection.send(r.tree())},n.prototype.login=function(t,e,n){function o(t){t==Strophe.Status.CONNECTING?console.log("Strophe is connecting."):t==Strophe.Status.CONNFAIL?console.log("Strophe failed to connect."):t==Strophe.Status.DISCONNECTING?(console.log("Strophe is disconnecting."),i.disconnected()):t==Strophe.Status.CONNECTED?(console.log("Strophe is connected."),i.connected(n)):t==Strophe.Status.AUTHFAIL?console.log("Strophe failed to connect."):t==Strophe.Status.ERROR&&console.log("Strophe failed to connect.")}this.userid=t,this.username=t+"@openid.ask-cs.com/web";var i=this;this.connection.connect(this.username,e,o)},n.prototype.connected=function(t){function e(t){var e=(t.getAttribute("to"),t.getAttribute("from")),o=(t.getAttribute("type"),t.getElementsByTagName("body")),i=t.getElementsByTagName("error");if(o.length>0){var a=o[0],r=JSON.parse(Strophe.getText(a));if(null!==r.result){var s=n.requests[r.id];s(r),n.requests.splice(r.id,1)}else null!==r.method&&console.log("Received new call: ",r)}if(i.length>0){var l=i[0];console.log(l),console.log("Received error from "+e+": "+Strophe.getText(l))}return!0}localStorage.capeclient_sid=this.connection.sid,localStorage.capeclient_rid=this.connection.rid,localStorage.capeclient_jid=this.connection.jid,localStorage.capeclient_uid=this.userid,this.connection.addHandler(e,null,"message",null,null,null),this.connection.send($pres().tree());var n=this;this.findDatasource(this.userid,"state",function(t){n.stateAgentUrl=t.result[0].agentUrl.replace("xmpp:","")}),null!==t&&t()},n.prototype.disconnect=function(t){this.connection.disconnect(),t()},n.prototype.disconnected=function(){localStorage.removeItem("capeclient_sid"),localStorage.removeItem("capeclient_rid"),localStorage.removeItem("capeclient_jid")},n.prototype.findDatasource=function(t,e,n){var o="merlin@openid.ask-cs.com/merlin",i={};i.userId=t,i.dataType=e,this.call(o,"find",i,n)},n.prototype.getSlots=function(t,e,n){if(null===this.stateAgentUrl)throw"No stateAgent found";null===t&&(t=(new Date).getTime()),null===e&&(e=t+1);var o={};o.start_millis=t,o.end_millis=e,this.call(this.stateAgentUrl,"getSlotsCombined",o,n)},n.prototype.setSlot=function(t,e,n,o,i){if(null===this.stateAgentUrl)throw"No stateAgent found";var a={};a.start_millis=t,a.end_millis=e,a.description=n,a.occurence=o,this.call(this.stateAgentUrl,"setSlot",a,i)},n.prototype.isConnected=function(){return this.connection.connected},n.prototype.call=function(t,e,n,i){this.requestid++;var a=new o(this.connection);a.send(this.requestid,t,e,n),this.requests[this.requestid]=i},new n}]);